# 冰壶比赛规则系统实现

## 概述

本项目实现了完整的冰壶比赛规则系统，基于用户提供的规则描述：

1. **得分规则**：每局比赛双方AI选手投掷完冰壶后，以场地上冰壶距离大本营圆心远近决定胜负，即每只位于大本营中、位置较另外一队所有壶都更接近圆心的壶可记为得分壶。每个得分壶记1分，每局结束后统计得分。

2. **先后手规则**：每场比赛的第一局先后手采用抽签方式产生，得分的队伍在下一局中是先手，如平局则双方交换先后手。

3. **自由防守区规则**：比赛设置自由防守区，比赛段的T线与前掷线之间，除大本营外的白色区域被指定为自由防守区。如果在第5壶（先手方第3壶）之前，由投壶直接或间接导致的，对方的壶被从自由防守区移到出局的位置，该投出的壶拿开，其余被触及的壶将放回违例发生前的位置。

## 文件结构

```
.
├── XMUice_V2now.py          # 增强的主要AI系统（集成了新规则）
├── curling_rules_manager.py # 冰壶规则管理器
├── curling_demo.py         # 规则演示程序
└── README.md               # 本文档
```

## 核心组件

### 1. CurlingRulesManager (curling_rules_manager.py)

规则管理器是整个系统的核心，实现了所有用户描述的冰壶比赛规则。

#### 主要功能：

- **得分计算** (`calculate_end_score`): 实现精确的冰壶得分规则
- **先后手管理** (`determine_next_first_hand`): 自动管理每局的先后手顺序
- **自由防守区监控** (`check_free_guard_zone_violation`): 检测和处理违例情况
- **比赛状态跟踪** (`update_game_state`): 跟踪整场比赛的进度和得分

#### 关键参数：

```python
# 大本营设置
house_center = [2.375, 4.88]  # 大本营圆心坐标
house_radius = 1.83           # 大本营半径

# 自由防守区设置
free_guard_zone = {
    'min_y': 6.71,  # T线到前掷线之间的区域开始
    'max_y': 9.75,  # 前掷线位置
    'min_x': 0.5,   # 左边界
    'max_x': 4.25   # 右边界
}
```

### 2. 增强的AI系统 (XMUice_V2now.py)

原有的TD3强化学习AI系统已被增强，集成了新的规则管理器：

#### 新增功能：

- **规则集成**: 使用`CurlingRulesManager`进行得分计算和规则检查
- **违例监控**: 实时检测自由防守区违例
- **状态跟踪**: 跟踪每一投的状态变化
- **智能奖励**: 基于新规则的奖励计算

#### 主要修改：

1. **get_reward函数**: 使用规则管理器计算更准确的奖励
2. **违例检测**: 在"GO"消息处理中添加自由防守区检查
3. **状态更新**: 在"SCORE"消息处理中更新规则管理器状态

## 使用方法

### 1. 运行演示程序

```bash
python3 curling_demo.py
```

演示程序将展示：
- 得分规则的各种场景
- 先后手规则的工作方式
- 自由防守区违例检测
- 完整比赛流程

### 2. 运行AI对战系统

```bash
python3 XMUice_V2now.py --host <服务器地址> --port <端口号> [--training]
```

参数说明：
- `--host`: 冰壶服务器地址
- `--port`: 服务器端口
- `--training`: 可选，启用训练模式

### 3. 规则管理器独立使用

```python
from curling_rules_manager import CurlingRulesManager

# 创建规则管理器
rules = CurlingRulesManager()

# 计算得分
team1_stones = [[2.375, 4.88], [2.5, 5.0], None, None, None, None, None, None]
team2_stones = [[2.6, 5.2], None, None, None, None, None, None, None]
score1, score2 = rules.calculate_end_score(team1_stones, team2_stones)

# 检查违例
moved_stones = [...]  # 移动的冰壶信息
has_violation, violations = rules.check_free_guard_zone_violation(
    shot_number, moved_stones, team_throwing
)
```

## 规则实现详细说明

### 1. 得分规则实现

```python
def calculate_end_score(self, team1_stones, team2_stones):
    """
    实现用户描述的得分规则：
    - 只有位于大本营内的冰壶才能得分
    - 距离圆心更近的冰壶优先得分
    - 每只比对方所有冰壶都更接近圆心的冰壶得1分
    """
```

**算法流程**：
1. 筛选出位于大本营内的冰壶
2. 按距离圆心的远近排序
3. 找到最接近圆心的冰壶所属队伍
4. 计算该队伍中比对方最近冰壶更近的冰壶数量

### 2. 先后手规则实现

```python
def determine_next_first_hand(self, team1_score, team2_score):
    """
    实现先后手规则：
    - 得分队伍下一局为先手
    - 平局则交换先后手
    """
```

**规则逻辑**：
- 获胜队伍（得分更多）→ 下一局先手
- 平局 → 交换当前先后手顺序
- 第一局通过随机抽签或指定方式确定

### 3. 自由防守区规则实现

```python
def check_free_guard_zone_violation(self, shot_number, moved_stones, team_throwing):
    """
    实现自由防守区规则：
    - 只在前4壶（第5壶之前）检查
    - 检查对方冰壶是否从自由防守区被移出场外
    - 违例时应用相应处罚
    """
```

**检查条件**：
1. 投壶次数 < 5（前4壶）
2. 被移动的是对方冰壶
3. 原位置在自由防守区内
4. 最终位置出界（None值表示）

**处罚措施**：
- 移除违例投出的冰壶
- 恢复被误移的冰壶到原位置

## 技术特性

### 1. 精确的几何计算
- 使用欧几里得距离计算冰壶到圆心的距离
- 精确的区域判断（大本营、自由防守区）
- 支持浮点坐标系统

### 2. 灵活的状态管理
- 完整的比赛状态跟踪
- 历史记录保存
- 可重置的游戏状态

### 3. 强化学习集成
- 与TD3算法无缝集成
- 基于规则的奖励函数
- 策略性能评估

### 4. 实时违例检测
- 自动检测冰壶位置变化
- 实时违例判断
- 自动处罚应用（在支持的环境中）

## 演示结果示例

```
==================================================
演示得分规则：位于大本营中且距离圆心更近的冰壶得分
==================================================

场景1：Team1有冰壶更接近圆心
Team1得分: 2, Team2得分: 0

==================================================
演示先后手规则：得分队伍下一局为先手，平局则交换先后手
==================================================

第1局结果: Team1获胜 (Team1: 2, Team2: 1)
下一局(第2局)先手: team1

第2局结果: 平局 (Team1: 0, Team2: 0)
下一局(第3局)先手: team2

==================================================
演示自由防守区规则：第5壶前不能将对方冰壶从自由防守区移出
==================================================

场景1：第3壶违例 - 将对方冰壶从自由防守区移出
是否违例: True
违例详情:
  - team2_stone_1 从 [2.5, 7.5] 被移出场外
处罚措施:
  - remove_stone: thrown_stone_1
  - restore_stone: team2_stone_1
```

## 扩展性

本系统设计具有良好的扩展性：

1. **新规则添加**: 可以轻松在`CurlingRulesManager`中添加新的规则
2. **不同比赛格式**: 支持不同局数和得分规则的比赛
3. **多种AI算法**: 规则管理器独立于AI算法，可与不同的AI系统集成
4. **自定义场地**: 可以调整场地参数以适应不同的冰壶场地规格

## 注意事项

1. **坐标系统**: 使用标准的冰壶场地坐标系统
2. **精度设置**: 位置变化检测使用0.001的容差值
3. **状态同步**: 确保游戏状态与规则管理器保持同步
4. **违例处理**: 在实际比赛环境中需要服务器支持违例处罚的应用

## 开发者信息

本实现严格按照用户提供的冰壶比赛规则进行开发，确保了规则的准确性和完整性。所有核心功能都经过了全面的测试和验证。